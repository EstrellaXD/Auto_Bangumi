# [2.6] リリースノート

## 古いバージョンからのアップグレードノート

バージョン2.6以降、AutoBangumi（AB）の設定は環境変数から`config.json`に移動しました。アップグレード前に以下の点に注意してください。

### 環境変数の移行

古い環境変数は、2.6へのアップグレード後の初回起動時に自動的に`config.json`に変換されます。生成された`config.json`は`/app/config`フォルダに配置されます。
`/app/config`フォルダをマッピングすると、古い環境変数はABの動作に影響しなくなります。`config.json`を削除すると、環境変数から再生成できます。

### コンテナボリュームマッピング

バージョン2.6以降、以下のフォルダをマッピングする必要があります：

- `/app/config`：`config.json`を含む設定フォルダ
- `/app/data`：`bangumi.json`などを含むデータフォルダ

### データファイル

大きな更新があるため、古いデータファイルの使用は推奨しません。ABは自動的に`/app/data`に新しい`bangumi.json`を生成します。

心配しないでください — QBは以前にダウンロードしたアニメを再ダウンロードしません。

### 以降の設定変更

ABはWebUIで直接設定を編集できるようになりました。編集後、変更を有効にするにはコンテナを再起動してください。

## アップグレード方法

### Docker Compose

既存のdocker-compose.ymlファイルを使用してアップグレードできます：

```bash
docker compose stop autobangumi
docker compose pull autobangumi
```

次に、docker-compose.ymlを変更してボリュームマッピングを追加します：

```yaml
version: "3.8"

services:
  autobangumi:
    image: estrellaxd/auto_bangumi:latest
    container_name: autobangumi
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      - /path/to/config:/app/config
      - /path/to/data:/app/data
    networks:
      - bridge
    dns:
      - 8.8.8.8
```

その後ABを起動します：

```bash
docker compose up -d autobangumi
```

### Portainer

Portainerで、ボリュームマッピングを変更し、`Recreate`をクリックしてアップグレードを完了します。

### アップグレードで問題が発生した場合

設定は様々であるため、アップグレードによりプログラムが失敗する場合があります。以前のすべてのデータと生成された設定ファイルを削除し、コンテナを再起動してWebUIで再設定してください。


## 新機能

### 設定方法の変更

v2.6以降、プログラム設定はDocker環境変数から`config.json`に移動しました。
新しいWebUIはWebベースの設定エディターも提供します。AB URLにアクセスし、サイドバーで`設定`を見つけて設定を変更してください。編集後はコンテナを再起動してください。

### カスタムリバースプロキシURLとABのプロキシリレー

[Mikan Project](https://mikanani.me)にアクセスできない状況に対処するため、ABは3つのアプローチを提供します：

1. HTTPとSOCKSプロキシ

    この機能は古いバージョンに存在しました。2.6にアップグレードした後、WebUIでプロキシ設定を確認するだけでMikan Projectに正常にアクセスできます。

    ただし、qBittorrentはまだMikanのRSSとトレントURLに直接アクセスできないため、qBittorrentにもプロキシを追加する必要があります。詳細は#198を参照してください。

2. カスタムリバースプロキシURL

    バージョン2.6ではカスタムリバースプロキシURL用の`custom_url`オプションが追加されました。
    適切に設定されたリバースプロキシURLに設定してください。ABはこのカスタムURLを使用してMikan Projectにアクセスし、QBは正常にダウンロードできます。

3. ABのプロキシリレー

    ABでプロキシを設定した後、ABはローカルプロキシリレーとして機能できます（現在はRSS関連機能のみ）。
    `custom_url`を`http://abhost:abport`に設定します。ここで`abhost`はABのIP、`abport`はABのポートです。
    ABは自分のアドレスをqBittorrentにプッシュし、qBittorrentはABをプロキシとして使用してMikan Projectにアクセスします。

    注意：NginxなどでABのリバースプロキシを設定していない場合は、適切な動作を確保するために`http://`を含めてください。

**重要な注意事項**

ABとQBが同じコンテナにある場合、`127.0.0.1`や`localhost`を使用しないでください。この方法では通信できません。
同じネットワーク上にある場合は、コンテナ名アドレッシングを使用してください。例：`http://autobangumi:7892`。

Dockerゲートウェイアドレスも使用できます。例：`http://172.17.0.1:7892`。

異なるホストにある場合は、ホストマシンのIPアドレスを使用してください。

### コレクションとフォルダのリネーム

ABはコレクションとフォルダ内のファイルをリネームし、メディアファイルをルートディレクトリに戻すことができるようになりました。
ABは保存パスに依存してシーズンとエピソード情報を決定するため、ABの標準に従ってコレクションファイルを配置してください。

バージョン**2.6.4**以降、ABはフォルダ内の字幕をリネームできます（機能はまだ改善中）。コレクションと字幕はデフォルトで`pn`形式リネームです。調整オプションはまだ利用できません。

**標準パス**

```
/downloads/Bangumi/Title/Season 1/xxx
```

### プッシュ通知

ABは`Telegram`と`ServerChan`を介してリネーム完了通知を送信できるようになりました。

WebUIで、プッシュ通知を有効にし、必要なパラメータを入力してください。

- Telegramには Bot TokenとChat IDが必要です。取得方法については様々なチュートリアルを参照してください。
- ServerChanにはTokenが必要です。取得方法については様々なチュートリアルを参照してください。
