# [2.6] 发布说明

## 从旧版本升级说明

从 2.6 版本开始，AutoBangumi (AB) 配置已从环境变量迁移到 `config.json`。升级前请注意以下事项。

### 环境变量迁移

升级到 2.6 后首次启动时，旧环境变量会自动转换为 `config.json`。生成的 `config.json` 放置在 `/app/config` 文件夹中。
一旦您映射了 `/app/config` 文件夹，旧环境变量将不再影响 AB 的运行。您可以删除 `config.json` 以从环境变量重新生成。

### 容器卷映射

2.6 版本之后，需要映射以下文件夹：

- `/app/config`：配置文件夹，包含 `config.json`
- `/app/data`：数据文件夹，包含 `bangumi.json` 等

### 数据文件

由于重大更新，我们不建议使用旧数据文件。AB 会在 `/app/data` 中自动生成新的 `bangumi.json`。

不用担心 — QB 不会重新下载之前已下载的动画。

### 后续配置更改

AB 现在可以直接在 WebUI 中编辑配置。编辑后重启容器即可生效。

## 如何升级

### Docker Compose

您可以使用现有的 docker-compose.yml 文件进行升级：

```bash
docker compose stop autobangumi
docker compose pull autobangumi
```

然后修改 docker-compose.yml 添加卷映射：

```yaml
version: "3.8"

services:
  autobangumi:
    image: estrellaxd/auto_bangumi:latest
    container_name: autobangumi
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Shanghai
    volumes:
      - /path/to/config:/app/config
      - /path/to/data:/app/data
    networks:
      - bridge
    dns:
      - 8.8.8.8
```

然后启动 AB：

```bash
docker compose up -d autobangumi
```

### Portainer

在 Portainer 中，修改卷映射并点击 `Recreate` 完成升级。

### 升级导致问题怎么办

由于配置可能各不相同，升级可能会导致程序失败。删除所有之前的数据和生成的配置文件，然后重启容器并在 WebUI 中重新配置。


## 新功能

### 配置方式变更

v2.6 之后，程序配置已从 Docker 环境变量迁移到 `config.json`。
新版 WebUI 还提供了基于 Web 的配置编辑器。访问 AB URL 并在侧边栏找到 `设置` 来修改配置。编辑后重启容器。

### 自定义反向代理 URL 和 AB 作为代理中继

为了处理 [Mikan Project](https://mikanani.me) 无法访问的情况，AB 提供了三种方法：

1. HTTP 和 SOCKS 代理

    此功能在旧版本中就存在。升级到 2.6 后，只需在 WebUI 中检查代理配置即可正常访问 Mikan Project。

    但是，qBittorrent 仍然无法直接访问 Mikan 的 RSS 和种子 URL，因此您也需要在 qBittorrent 中添加代理。详见 #198。

2. 自定义反向代理 URL

    2.6 版本添加了 `custom_url` 选项用于自定义反向代理 URL。
    将其设置为您正确配置的反向代理 URL。AB 将使用此自定义 URL 访问 Mikan Project，QB 可以正常下载。

3. AB 作为代理中继

    在 AB 中配置代理后，AB 可以作为本地代理中继（目前仅用于 RSS 相关功能）。
    将 `custom_url` 设置为 `http://abhost:abport`，其中 `abhost` 是 AB 的 IP，`abport` 是 AB 的端口。
    AB 将把自己的地址推送给 qBittorrent，qBittorrent 将使用 AB 作为代理来访问 Mikan Project。

    注意：如果您没有使用 Nginx 或类似工具为 AB 设置反向代理，请包含 `http://` 以确保正常运行。

**重要说明**

如果 AB 和 QB 在同一个容器中，不要使用 `127.0.0.1` 或 `localhost`，它们无法通过这种方式通信。
如果在同一网络中，使用容器名称寻址，例如 `http://autobangumi:7892`。

您也可以使用 Docker 网关地址，例如 `http://172.17.0.1:7892`。

如果在不同主机上，使用主机的 IP 地址。

### 合集和文件夹重命名

AB 现在可以重命名合集和文件夹中的文件，将媒体文件移回根目录。
请注意，AB 仍然依赖保存路径来确定季度和集数信息，因此请按照 AB 的标准放置合集文件。

**2.6.4** 版本之后，AB 可以重命名文件夹中的字幕（功能仍在完善中）。合集和字幕默认使用 `pn` 格式重命名；调整选项尚未提供。

**标准路径**

```
/downloads/Bangumi/Title/Season 1/xxx
```

### 推送通知

AB 现在可以通过 `Telegram` 和 `ServerChan` 发送重命名完成通知。

在 WebUI 中启用推送通知并填写所需参数。

- Telegram 需要 Bot Token 和 Chat ID。获取方法请参考各种教程。
- ServerChan 需要 Token。获取方法请参考各种教程。
